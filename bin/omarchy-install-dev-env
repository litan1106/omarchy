#!/bin/bash

# Install one of the supported development environments. Usually called via Install > Development > * in the Omarchy Menu.

if [[ -z "$1" ]]; then
  echo "Usage: omarchy-install-dev-env <ruby|node|bun|go|laravel|symfony|php[:version] [extensions...]|python|elixir|phoenix|rust|java|ocaml|dotnet|clojure>" >&2
  echo "Examples:" >&2
  echo "  omarchy-install-dev-env php                    # Install latest PHP" >&2
  echo "  omarchy-install-dev-env php:8.2                # Install PHP 8.2" >&2
  echo "  omarchy-install-dev-env php:8.1 redis mongodb  # Install PHP 8.1 with extensions" >&2
  echo "  omarchy-install-dev-env php redis grpc sodium  # Install latest PHP with extensions" >&2
  echo "" >&2
  echo "Available PHP extensions: redis, mongodb, grpc, protobuf, igbinary, sodium, gmp" >&2
  exit 1
fi

install_php() {
  local php_version="${1:-latest}"
  shift # Remove first argument (version)
  local extensions=("$@") # Remaining arguments are extensions
  
  echo "Installing PHP build dependencies..."
  
  # Install build dependencies for compiling PHP from source
  sudo pacman -S --needed --noconfirm \
    base-devel \
    re2c \
    autoconf \
    bison \
    curl \
    libxml2 \
    openssl \
    zlib \
    readline \
    gettext \
    libjpeg-turbo \
    libpng \
    freetype2 \
    gd \
    icu \
    oniguruma \
    sqlite \
    postgresql-libs \
    libzip \
    libxslt \
    gmp \
    libedit \
    libsodium \
    protobuf \
    grpc \
    hiredis \
    mongodb-tools
  
  echo "Installing PHP ${php_version} via mise..."
  
  # Install PHP via mise for version management
  mise use --global "php@${php_version}"
  
  # Install Composer globally via mise
  mise use --global composer@latest
  
  # Install PECL extensions if requested
  if [[ ${#extensions[@]} -gt 0 ]]; then
    echo "Installing PHP extensions: ${extensions[*]}"
    
    # Get PHP installation path
    php_path=$(mise where php@${php_version})
    
    for ext in "${extensions[@]}"; do
      case "$ext" in
        redis)
          echo "Installing Redis extension..."
          mise exec php@${php_version} -- pecl install redis
          echo "extension=redis.so" >> "${php_path}/conf.d/php.ini"
          ;;
        mongodb)
          echo "Installing MongoDB extension..."
          mise exec php@${php_version} -- pecl install mongodb
          echo "extension=mongodb.so" >> "${php_path}/conf.d/php.ini"
          ;;
        grpc)
          echo "Installing gRPC extension..."
          mise exec php@${php_version} -- pecl install grpc
          echo "extension=grpc.so" >> "${php_path}/conf.d/php.ini"
          ;;
        protobuf)
          echo "Installing Protobuf extension..."
          mise exec php@${php_version} -- pecl install protobuf
          echo "extension=protobuf.so" >> "${php_path}/conf.d/php.ini"
          ;;
        igbinary)
          echo "Installing Igbinary extension..."
          mise exec php@${php_version} -- pecl install igbinary
          echo "extension=igbinary.so" >> "${php_path}/conf.d/php.ini"
          ;;
        sodium)
          echo "Enabling Sodium extension (built-in)..."
          echo "extension=sodium" >> "${php_path}/conf.d/php.ini"
          ;;
        gmp)
          echo "Enabling GMP extension (built-in)..."
          echo "extension=gmp" >> "${php_path}/conf.d/php.ini"
          ;;
        *)
          echo "Installing ${ext} extension..."
          mise exec php@${php_version} -- pecl install "$ext" || true
          echo "extension=${ext}.so" >> "${php_path}/conf.d/php.ini"
          ;;
      esac
    done
    
    echo "Extensions installed. Verifying..."
    mise exec php@${php_version} -- php -m | grep -E "(redis|mongodb|grpc|protobuf|igbinary|sodium|gmp)" || true
  fi
  
  # Install Path for Composer
  if [[ ":$PATH:" != *":$HOME/.config/composer/vendor/bin:"* ]]; then
    echo 'export PATH="$HOME/.config/composer/vendor/bin:$PATH"' >>"$HOME/.bashrc"
    source "$HOME/.bashrc"
    echo "Added Composer global bin directory to PATH."
  else
    echo "Composer global bin directory already in PATH."
  fi
  
  echo "PHP ${php_version} installation completed via mise."
  echo "You can switch PHP versions using: mise use php@<version>"
  echo "Available versions can be listed with: mise list-remote php"
  echo "To install extensions later: omarchy-install-dev-env php:${php_version} redis mongodb grpc"
}

install_node() {
  echo -e "Installing Node.js...\n"
  mise use --global node
}

case "$1" in
ruby)
  echo -e "Installing Ruby on Rails...\n"
  omarchy-pkg-add libyaml
  mise use --global ruby@latest
  mise settings add idiomatic_version_file_enable_tools ruby
  echo "gem: --no-document" > ~/.gemrc
  mise x ruby -- gem install rails --no-document
  echo -e "\nYou can now run: rails new myproject"
  ;;
node)
  install_node
  ;;
bun)
  echo -e "Installing Bun...\n"
  mise use -g bun@latest
  ;;
deno)
  echo -e "Installing Deno...\n"
  mise use -g deno@latest
  ;;
go)
  echo -e "Installing Go...\n"
  mise use --global go@latest
  ;;
php*)
  # Parse PHP version if specified (e.g., php:8.2)
  if [[ "$1" == *":"* ]]; then
    php_version="${1#*:}"
  else
    php_version="latest"
  fi
  
  # Shift to get extension arguments
  shift
  extensions=("$@")
  
  echo -e "Installing PHP ${php_version}...\n"
  if [[ ${#extensions[@]} -gt 0 ]]; then
    echo "With extensions: ${extensions[*]}"
    install_php "$php_version" "${extensions[@]}"
  else
    install_php "$php_version"
  fi
  ;;
laravel)
  echo -e "Installing PHP and Laravel...\n"
  install_php
  install_node
  composer global require laravel/installer
  echo -e "\nYou can now run: laravel new myproject"
  ;;
symfony)
  echo -e "Installing PHP and Symfony...\n"
  install_php
  omarchy-pkg-add symfony-cli
  echo -e "\nYou can now run: symfony new --webapp myproject"
  ;;
python)
  echo -e "Installing Python...\n"
  mise use --global python@latest
  echo -e "\nInstalling uv...\n"
  curl -fsSL https://astral.sh/uv/install.sh | sh
  ;;
elixir)
  echo -e "Installing Elixir...\n"
  mise use --global erlang@latest
  mise use --global elixir@latest
  mise x elixir -- mix local.hex --force
  ;;
phoenix)
  echo -e "Installing Phoenix Framework...\n"
  # Ensure Erlang/Elixir first
  mise use --global erlang@latest
  mise use --global elixir@latest
  # Hex & Rebar
  mise x elixir -- mix local.hex --force
  mise x elixir -- mix local.rebar --force
  # Phoenix project (phx_new)
  mise x elixir -- mix archive.install hex phx_new --force
  echo -e "\nYou can now run: mix phx.new my_app"
  ;;
rust)
  echo -e "Installing Rust...\n"
  bash -c "$(curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs)" -- -y
  ;;
java)
  echo -e "Installing Java...\n"
  mise use --global java@latest
  ;;
zig)
  echo -e "Installing Zig...\n"
  mise use --global zig@latest
  mise use -g zls@latest
  ;;
ocaml)
  echo -e "Installing OCaml...\n"
  bash -c "$(curl -fsSL https://raw.githubusercontent.com/ocaml/opam/master/shell/install.sh)"
  opam init --yes
  eval "$(opam env)"
  opam install ocaml-lsp-server odoc ocamlformat utop --yes
  ;;
dotnet)
  echo -e "Installing .NET...\n"
  mise use --global dotnet@latest
  ;;
clojure)
  echo -e "Installing Clojure...\n"
  omarchy-pkg-add rlwrap
  mise use --global clojure@latest
  ;;
esac
